# NUC1261 雙韌體 OTA 更新詳細流程說明

## 一、系統設計概述

本專案 MCU 端支援雙韌體分區（APROM1、APROM2），每區皆有獨立韌體與 Metadata。  
OTA 更新時，MCU 會將新韌體寫入備援分區，並以 Metadata 管理狀態、版本與完整性，確保升級過程安全可靠。

---

## 二、開機與自我驗證流程

1. **開機自檢**
   - MCU 開機後，讀取兩個分區的 Metadata。
   - 依據 Metadata 狀態（ACTIVE、PENDING、FAIL）決定啟動哪一區韌體。
   - 執行 CRC32 韌體自我驗證。
   - 若驗證失敗，嘗試切換至另一分區；若皆失敗則進入安全模式。

2. **啟動後狀態標記**
   - 驗證通過後，將該分區 Metadata 標記為 ACTIVE。
   - 若驗證失敗，將該分區標記為 FAIL，並重啟 MCU。

---

## 三、OTA 更新與分區切換流程

1. **OTA 觸發**
   - PC 端透過 UART 傳送 OTA 指令與新韌體資料（每包 100 bytes）。
   - MCU 解析封包，將新韌體寫入備援分區，並將該分區 Metadata 狀態設為 PENDING。

2. **寫入與驗證**
   - MCU 寫入完成後，計算新韌體 CRC32，與 Metadata 比對。
   - 驗證通過則將 Metadata 狀態設為 ACTIVE，原本分區標記為 OLD 或 INACTIVE。

3. **分區切換**
   - MCU 透過 UART 指令或自動重啟，切換至新分區執行。
   - 開機後再次進行自我驗證，確認新韌體可正常運作。

4. **OTA 結果回報**
   - MCU 透過 UART 回報 OTA 結果（成功/失敗）。
   - 若新韌體異常，MCU 自動回滾至舊分區。

---

## 四、UART OTA 封包格式

- **長度**：100 bytes
- **Header**：0x55，**Tail**：0x0A
- **結構**：
  | Byte  | 說明         |
  |-------|--------------|
  | 0     | Header (0x55)|
  | 1     | 保留         |
  | 2     | 命令碼       |
  | 3     | 封包編號     |
  | 4~95  | Payload      |
  | 96~97 | 保留         |
  | 98    | Checksum     |
  | 99    | Tail (0x0A)  |

- 詳細協定請參考 `UART協定說明.pdf`

---

## 五、Metadata 狀態旗標說明

| 狀態      | 說明                         |
|-----------|------------------------------|
| ACTIVE    | 當前執行且驗證通過的韌體     |
| PENDING   | 剛寫入、待驗證的新韌體       |
| FAIL      | 驗證失敗或不可執行的韌體     |

---

## 六、常用 OTA 指令

| 指令名稱           | 說明                   |
|--------------------|------------------------|
| UPDATE_FW          | 寫入新韌體             |
| UPDATE_METADATA    | 寫入新 Metadata        |
| GET_CRC32          | 查詢指定分區 CRC32     |
| SWITCH_FW          | 切換分區執行           |
| GET_STATUS         | 查詢分區與狀態         |
| RESET              | MCU 軟體重啟           |

---

## 七、OTA 失敗與回滾機制

- 若新韌體驗證失敗，MCU 會自動回滾至舊分區，並標記新分區為 FAIL。
- 若兩分區皆失敗，MCU 進入安全模式，等待外部修復。

---

## 八、注意事項

- OTA 過程請勿斷電或中斷 UART 連線。
- Metadata 與韌體需配對，避免版本不一致。
- 詳細 UART 封包格式與命令請參考 `UART協定說明.pdf`。
- 若需擴充協定或流程，請參閱原始碼註解。

---

如需進階設定或協定擴充，請聯絡專案維護者或參閱原始碼。